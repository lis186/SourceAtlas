# SourceAtlas 分析憲法 (Analysis Constitution)

**版本**: 1.1 | **生效日期**: 2025-12-05 | **狀態**: 生效中

> 本文件定義 SourceAtlas 分析的**不可變原則**。
> 所有分析命令（/atlas.*）必須遵守這些原則。
> 違反原則的分析結果應被視為不完整。

---

## Article I: 資訊理論原則 (Information Theory)

### Section 1.1: 高熵優先
> **不可變**: 永遠優先掃描高熵檔案，而非線性遍歷。

高熵檔案的掃描順序：
1. **配置檔案**（package.json, go.mod, Cargo.toml, pyproject.toml）
2. **專案文檔**（README.md, CLAUDE.md, ARCHITECTURE.md）
3. **核心模型**（models/, entities/, domain/）
4. **入口點**（main.*, index.*, app.*）
5. **測試範例**（1-2 個代表性測試）

**驗證**: 每次分析必須記錄「掃描的高熵檔案」清單。

### Section 1.2: 掃描比例上限
> **不可變**: 掃描檔案數不得超過專案總檔案數的規定比例。

| 專案規模 | 檔案數 | 最大掃描比例 | 最大掃描數 |
|---------|--------|-------------|-----------|
| TINY | <20 | 50% | 10 |
| SMALL | 20-50 | 20% | 10 |
| MEDIUM | 50-150 | 10% | 15 |
| LARGE | 150-500 | 5% | 25 |
| VERY_LARGE | >500 | 3% | 30 |

**驗證**: 分析報告必須包含 `scan_ratio` 欄位，違反上限應發出警告。

### Section 1.3: 結構優於細節
> **指導**: 理解專案結構比閱讀實作細節更重要。

優先順序：
1. 目錄結構和命名慣例
2. 模組間的依賴關係
3. API 契約和介面定義
4. 實作細節（僅在必要時）

---

## Article II: 排除原則 (Exclusion Policy)

### Section 2.1: 強制排除目錄
> **不可變**: 以下目錄在任何情況下都必須排除於檔案計數和掃描。

```
.venv/           # Python 虛擬環境
node_modules/    # Node.js 依賴
vendor/          # PHP/Go 依賴
__pycache__/     # Python 快取
.git/            # Git 內部
Pods/            # iOS CocoaPods
DerivedData/     # Xcode 建置產物
build/           # 通用建置目錄
dist/            # 通用發布目錄
target/          # Rust/Maven 建置
.next/           # Next.js 建置
.nuxt/           # Nuxt.js 建置
```

**驗證**: 偵測腳本必須在檔案計數前排除這些目錄。

### Section 2.2: 條件排除
> **可配置**: 以下目錄預設包含，但可由使用者排除。

```
tests/           # 測試目錄
docs/            # 文檔目錄
examples/        # 範例目錄
```

---

## Article III: 假設原則 (Hypothesis Policy)

### Section 3.1: 假設數量限制
> **不可變**: 假設數量必須根據專案規模調整。

| 專案規模 | 假設數量目標 | 低信心假設上限 |
|---------|-------------|---------------|
| TINY | 5-8 | 2 |
| SMALL | 7-10 | 3 |
| MEDIUM | 10-15 | 4 |
| LARGE | 12-18 | 5 |
| VERY_LARGE | 15-20 | 6 |

**定義**: 低信心假設 = confidence < 0.5

**驗證**: 超過低信心假設上限時，必須優先將最弱的假設轉為「需要驗證」標記，或透過額外掃描提升信心。

### Section 3.2: 假設必要元素
> **不可變**: 每個假設必須包含以下欄位。

```yaml
hypothesis: "陳述句，描述推論內容"
confidence: 0.0-1.0  # 信心等級
evidence: "file:line 格式的證據引用"
validation_method: "如何在後續階段驗證"
```

**驗證**: 缺少任何欄位的假設應被視為不完整。

### Section 3.3: 信心等級校準
> **指導**: 信心等級應遵循以下標準。

| 信心區間 | 含義 | 證據要求 |
|---------|------|---------|
| 0.85-1.0 | 幾乎確定 | 配置檔案明確聲明 |
| 0.7-0.85 | 高度可能 | 多個間接證據支持 |
| 0.5-0.7 | 中等可能 | 單一間接證據 |
| 0.0-0.5 | 需要驗證 | 推測，缺乏直接證據 |

### Section 3.4: 假設優先級
> **指導**: 當需要取捨時，優先保留以下類型的假設。

優先順序（高 → 低）：
1. **架構假設**（整體結構、設計模式）
2. **技術棧假設**（語言、框架、資料庫）
3. **業務領域假設**（專案做什麼）
4. **開發實踐假設**（測試、CI/CD）
5. **AI 協作假設**（Level 0-4）

---

## Article IV: 證據原則 (Evidence Policy)

### Section 4.1: 證據格式
> **不可變**: 所有論點必須有證據支持，使用標準格式。

```
file_path:line_number  # 精確引用
```

範例：
- `src/models/User.php:42` - 精確行號
- `README.md:15-30` - 範圍引用
- `package.json` - 整檔引用（僅用於配置檔）

### Section 4.2: 證據類型層級
> **指導**: 不同類型的證據有不同的可信度。

| 證據類型 | 可信度 | 範例 |
|---------|--------|------|
| 配置宣告 | 最高 | package.json 中的 dependencies |
| 文檔陳述 | 高 | README.md 的專案描述 |
| 程式碼結構 | 中高 | 目錄命名、檔案組織 |
| 程式碼內容 | 中 | import 語句、類別定義 |
| 推論 | 低 | 基於模式的猜測 |

### Section 4.3: 禁止無證據論點
> **不可變**: 禁止在分析報告中出現無證據的結論性陳述。

❌ 錯誤：「這是一個高品質的專案」
✅ 正確：「這是一個高品質的專案（證據：測試覆蓋率配置 `.github/workflows/ci.yml:45`，lint 規則 `.eslintrc.js`）」

---

## Article V: 輸出原則 (Output Policy)

### Section 5.1: 格式標準
> **不可變**: 輸出格式必須遵循以下標準。

| 分析類型 | 格式 | 原因 |
|---------|------|------|
| Stage 0 指紋 | YAML | 結構化、機器可讀 |
| Stage 1 驗證 | Markdown | 人類可讀報告 |
| Stage 2 歷史 | Markdown | 敘事性分析 |
| 快速命令 | Markdown | 即時回饋 |

### Section 5.2: 必要元資料
> **不可變**: 所有分析輸出必須包含以下元資料。

```yaml
metadata:
  analysis_time: "ISO 8601 時間戳"
  total_files: N        # 專案總檔案數（排除後）
  scanned_files: M      # 實際掃描檔案數
  scan_ratio: "X.X%"    # M/N 的百分比
  project_scale: "TINY|SMALL|MEDIUM|LARGE|VERY_LARGE"
  constitution_version: "1.0"
```

### Section 5.3: 語言規範
> **指導**: 輸出語言應匹配使用者偏好或專案主要語言。

- 預設：繁體中文（台灣用語）
- 技術術語：保留英文原文
- 專有名詞：不翻譯（如 React, Django, Kubernetes）

### Section 5.4: 內建品質檢查
> **指導**: 每個命令應在輸出前自動驗證品質，發現問題時內嵌警告。

**檢查項目**（按優先序）：

| 檢查 | 嚴重性 | 警告訊息範例 |
|------|--------|-------------|
| scan_ratio 超出上限 | ⚠️ HIGH | `⚠️ scan_ratio 12% 超出 MEDIUM 專案上限 10%` |
| 假設缺少必要欄位 | ⚠️ HIGH | `⚠️ 假設 #3 缺少 evidence 欄位` |
| 證據格式不正確 | ⚠️ MEDIUM | `⚠️ 證據格式應為 file:line，發現 "src/app.ts"` |
| 缺少必要元資料 | ⚠️ MEDIUM | `⚠️ 缺少 project_scale 元資料` |
| 低信心假設過多 | ℹ️ INFO | `ℹ️ 5 個低信心假設，建議進一步驗證` |

**警告格式**：
```markdown
---
⚠️ **品質警告**
- scan_ratio 12% 超出上限
- 假設 #3 缺少 evidence 欄位
---
```

**原則**：
- 警告應內嵌於輸出中，不阻斷流程
- 優先顯示 HIGH 嚴重性問題
- 保持簡潔，每個警告一行

---

## Article VI: 規模感知原則 (Scale-Aware Policy)

### Section 6.1: 規模判定
> **不可變**: 專案規模根據排除後的程式碼檔案數判定。

```
TINY:       < 20 files
SMALL:      20 - 50 files
MEDIUM:     50 - 150 files
LARGE:      150 - 500 files
VERY_LARGE: > 500 files
```

### Section 6.2: 規模感知行為
> **不可變**: 不同規模的專案需要不同的分析策略。

| 行為 | TINY | SMALL | MEDIUM | LARGE | VERY_LARGE |
|------|------|-------|--------|-------|------------|
| 掃描深度 | 深 | 中深 | 中 | 淺 | 很淺 |
| 假設數量 | 5-8 | 7-10 | 10-15 | 12-18 | 15-20 |
| 模型掃描 | 全部 | 全部 | 3-5 | 3-5 | 5-7 |
| 測試掃描 | 全部 | 2-3 | 1-2 | 1-2 | 2-3 |

### Section 6.3: 微型專案特例
> **指導**: TINY 專案（<20 files）可能不需要完整的 SourceAtlas 分析。

建議：
- <10 files：直接閱讀，無需系統化分析
- 10-20 files：使用 `/atlas.overview` 快速掃描即可
- >20 files：正常 SourceAtlas 流程

---

## Article VII: Handoffs 原則 (Handoffs Policy)

### Section 7.1: 發現驅動
> **不可變**: Handoffs 必須基於實際分析發現，非靜態列表。

每個 handoff 建議必須：
- 引用當前分析的具體發現
- 解釋為什麼這個建議與發現相關
- 提供具體可執行的參數

❌ 禁止：「可以用 /atlas.pattern 了解更多」
✅ 正確：「`/atlas.pattern "repository"` - 發現 Repository 模式被 15 處使用，需了解實作慣例」

### Section 7.2: 結束條件
> **不可變**: 當滿足以下任一條件時，應省略 `recommended_next` 區塊。

| 條件 | 說明 |
|------|------|
| **分析深度足夠** | 已執行 4+ 個命令涵蓋多維度（overview + pattern + flow + history/impact） |
| **專案規模太小** | TINY 專案（<10 files）可直接閱讀全部檔案 |
| **發現太模糊** | 無法給出高信心（>0.7）的建議參數 |
| **目標已達成** | 使用者的問題已獲解答 |

當省略 handoffs 時，應提供結束提示：
```markdown
✅ **分析已足夠** - 可以開始實作

基於以上發現，建議優先處理：
1. [具體行動項目]
2. [具體行動項目]
```

### Section 7.3: 建議數量與格式
> **不可變**: Handoffs 建議遵循以下規則。

- **Primary**: 必須提供（除非滿足結束條件）
- **Secondary**: 可選（僅在有明確相關的第二選項時提供）

**禁止**為了格式一致而強行提供 Secondary 建議。
當只有一個明確方向時，只提供 Primary。

**輸出格式**：使用編號表格，方便用戶快速選擇：

```markdown
## Recommended Next

| # | 命令 | 用途 |
|---|------|------|
| 1 | `/atlas.pattern "repository"` | 發現 Repository 模式被 15 處使用，需了解實作慣例 |
| 2 | `/atlas.flow "checkout"` | 追蹤結帳流程的完整執行路徑 |

💡 輸入數字（如 `1`）或複製命令執行
```

用戶可直接輸入 `1` 快速執行，也可複製完整命令。

### Section 7.4: 參數品質
> **不可變**: Handoffs 參數必須滿足以下品質標準。

| 要求 | 說明 | 範例 |
|------|------|------|
| **具體** | 包含可執行的參數 | ✅ `/atlas.pattern "repository"` |
| **非泛泛** | 避免抽象描述 | ❌ `/atlas.pattern "相關 pattern"` |
| **可驗證** | 參數對應實際存在的目標 | 檔案路徑存在、pattern 名稱有效 |
| **基於發現** | 參數來自當前分析結果 | ✅ 使用分析中發現的實際檔案名 |

### Section 7.5: 理由品質
> **不可變**: 每個建議的 `why` 欄位必須：

1. 引用當前分析的**具體發現**（數字、檔案名、問題）
2. 解釋發現與建議的**因果關係**
3. 使用 **1-2 句話**簡潔表達

❌ 禁止：「了解更多細節」
✅ 正確：「發現 setSQL.py 被 3 個模組依賴且無測試，需評估修改風險」

---

## Article VIII: 修訂原則 (Amendment Policy)

### Section 8.1: 修訂流程
> 本憲法的修訂需要：

1. 在 `ideas/` 提出修訂建議
2. 在 3+ 個專案驗證新原則
3. 更新 `dev-notes/` 記錄決策理由
4. 遞增版本號
5. 更新生效日期

### Section 8.2: 版本號規則

- **MAJOR**（如 1.0 → 2.0）：不向後相容的原則變更
- **MINOR**（如 1.0 → 1.1）：新增原則或澄清
- **PATCH**（如 1.0.0 → 1.0.1）：錯字修正、格式調整

### Section 8.3: 向後相容
> **指導**: 修訂應盡量保持向後相容，使先前有效的分析結果仍然有效。

---

## Appendix A: 快速檢查清單

### 分析前檢查
- [ ] 確認專案路徑正確
- [ ] 排除目錄已配置（.venv, node_modules 等）
- [ ] 確定專案規模（TINY/SMALL/MEDIUM/LARGE/VERY_LARGE）

### 分析中檢查
- [ ] 優先掃描高熵檔案
- [ ] 掃描比例在規定上限內
- [ ] 假設數量符合專案規模
- [ ] 每個假設有完整四要素

### 分析後檢查
- [ ] 輸出包含必要元資料
- [ ] 每個論點有證據支持
- [ ] 低信心假設不超過上限
- [ ] 格式符合規定（YAML/Markdown）

### 內建品質檢查（Section 5.4）
- [ ] 輸出前執行自動驗證
- [ ] HIGH 嚴重性問題以 `⚠️` 警告顯示
- [ ] 警告內嵌於輸出中，不阻斷流程
- [ ] 警告格式正確（每個一行，優先 HIGH）

### Handoffs 檢查（Article VII）
- [ ] 是否滿足結束條件？若是，省略 `recommended_next`
- [ ] Primary 建議有具體參數（非泛泛描述）
- [ ] Secondary 只在有明確第二選項時提供
- [ ] 理由引用當前分析的具體發現
- [ ] 參數基於實際發現（檔案名、pattern 名稱）

---

## Appendix B: 術語表

| 術語 | 定義 |
|------|------|
| **高熵檔案** | 包含大量專案資訊的檔案（配置、文檔、模型） |
| **掃描比例** | 實際掃描檔案數 / 專案總檔案數 |
| **假設** | 基於掃描結果的推論，待後續驗證 |
| **信心等級** | 對假設正確性的主觀估計（0.0-1.0） |
| **證據** | 支持論點的具體檔案引用 |

---

## Appendix C: 與其他文件的關係

| 文件 | 關係 |
|------|------|
| `CLAUDE.md` | 開發指南（如何開發 SourceAtlas），本憲法聚焦分析行為 |
| `PROMPTS.md` | 完整 prompt 模板，應遵循本憲法原則 |
| `.claude/commands/atlas.*.md` | 命令實作，必須引用本憲法 |
| `scripts/atlas/*.sh` | 輔助腳本，應實作本憲法的排除和計數邏輯 |

---

**文件結束**

*此憲法由 SourceAtlas 團隊維護。如有疑問或建議，請在 `ideas/` 目錄提出。*
