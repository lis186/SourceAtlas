# 智慧 Cache 過期閾值

**狀態**: 🟡 研究中
**來源**: DX 工程師測試報告建議 (2025-12-13)
**優先級**: 低

---

## 使用場景

### 問題描述

目前所有分析命令使用統一的 30 天過期閾值，但不同類型的分析有不同的「有效期」：

| 分析類型 | 變動頻率 | 目前閾值 | 問題 |
|----------|----------|----------|------|
| overview | 低（專案結構穩定） | 30 天 | 適中 |
| pattern | 很低（Pattern 很少變） | 30 天 | 太短，浪費重新分析 |
| history | 高（每次 commit 都變） | 30 天 | **太長，資料過時** |
| deps | 高（Library 常更新） | 30 天 | **太長，可能漏掉重要更新** |
| impact | 中（依賴關係可能變） | 30 天 | 稍長 |
| flow | 低（流程相對穩定） | 30 天 | 適中 |

**痛點**：
- `history` 和 `deps` 的 30 天快取可能已經嚴重過時
- `pattern` 的 30 天警告可能造成不必要的重新分析

### 目標用戶

- 追求分析準確性的開發者
- 需要最新依賴資訊的技術負責人
- 重視效率（避免不必要重分析）的使用者

### 為什麼需要

- **準確性**：快速變動的分析（history, deps）需要更短的有效期
- **效率**：穩定的分析（pattern）不需要頻繁重新分析
- **智慧化**：根據分析性質自動判斷，減少使用者心智負擔

---

## 功能設計

### 建議的差異化閾值

| 分析類型 | 建議閾值 | 原因 |
|----------|----------|------|
| `overview` | **30 天** | 專案結構、技術棧相對穩定 |
| `pattern` | **60 天** | Pattern 實作很少變動，除非重構 |
| `history` | **7 天** | Git 歷史每次 commit 都在變，hotspots 可能快速變化 |
| `deps` | **7 天** | Library 更新頻繁，升級建議需要最新資訊 |
| `impact` | **14 天** | 依賴關係中等頻率變動 |
| `flow` | **30 天** | 業務流程相對穩定，除非重大重構 |

### 使用者體驗

**Cache Check 輸出（以 history 為例）**：
```
📁 載入快取：.sourceatlas/history.md（5 天前）
💡 重新分析請加 --force
```

**過期警告（以 history 為例，7 天閾值）**：
```
📁 載入快取：.sourceatlas/history.md（10 天前）
⚠️ 快取已超過 7 天，建議重新分析（Git 歷史變動頻繁）
💡 重新分析請加 --force
```

### `/atlas.list` 整合

過期判斷使用各類型的專屬閾值：

```
| 類型 | 檔案 | 大小 | 修改時間 | 狀態 |
|------|------|------|----------|------|
| overview | overview.yaml | 2.3 KB | 25 天前 | ✅ |
| pattern | patterns/api.md | 1.5 KB | 45 天前 | ✅ |  ← 60 天閾值，尚未過期
| history | history.md | 4.2 KB | 10 天前 | ⚠️ 過期 |  ← 7 天閾值，已過期
| deps | deps/react.md | 2.1 KB | 5 天前 | ✅ |
```

---

## 技術設計

### 方案 A：硬編碼在各命令中（簡單）

在每個命令的 Cache Check 區塊直接寫入專屬閾值：

```markdown
# atlas.history.md
- **如果超過 7 天**，額外顯示：
  ```
  ⚠️ 快取已超過 7 天，建議重新分析（Git 歷史變動頻繁）
  ```

# atlas.pattern.md
- **如果超過 60 天**，額外顯示：
  ```
  ⚠️ 快取已超過 60 天，建議重新分析
  ```
```

**優點**：簡單直接，無需額外配置
**缺點**：閾值分散在各檔案，調整需改多處

### 方案 B：集中配置（進階）

建立 `.sourceatlas/config.yaml`：

```yaml
cache_expiry:
  overview: 30
  pattern: 60
  history: 7
  deps: 7
  impact: 14
  flow: 30
```

各命令讀取此配置決定閾值。

**優點**：集中管理，使用者可自訂
**缺點**：增加複雜度，需要讀取配置的邏輯

### 建議

**Phase 1**：採用方案 A（硬編碼），快速實作
**Phase 2**：如有需求，升級為方案 B（可配置）

---

## 實作計畫

### 需修改的檔案

| 檔案 | 目前閾值 | 新閾值 | 警告訊息 |
|------|---------|--------|----------|
| `atlas.overview.md` | 30 天 | 30 天 | （不變） |
| `atlas.pattern.md` | 30 天 | **60 天** | 快取已超過 60 天 |
| `atlas.history.md` | 30 天 | **7 天** | 快取已超過 7 天（Git 歷史變動頻繁） |
| `atlas.deps.md` | 30 天 | **7 天** | 快取已超過 7 天（Library 更新頻繁） |
| `atlas.impact.md` | 30 天 | **14 天** | 快取已超過 14 天 |
| `atlas.flow.md` | 30 天 | 30 天 | （不變） |

### 步驟

1. [ ] 修改 `atlas.pattern.md`：30 → 60 天
2. [ ] 修改 `atlas.history.md`：30 → 7 天，加入原因說明
3. [ ] 修改 `atlas.deps.md`：30 → 7 天，加入原因說明
4. [ ] 修改 `atlas.impact.md`：30 → 14 天
5. [ ] 同步到 plugin/commands/
6. [ ] 更新 `/atlas.list`（如已實作過期標記功能）
7. [ ] 更新 `/atlas.refresh`（如已實作）

### 測試

1. 各類型快取的過期判斷是否正確
2. 警告訊息是否清晰
3. `/atlas.list` 和 `/atlas.refresh` 是否使用正確閾值

---

## 風險評估

### 風險 1：使用者困惑

**問題**：不同命令的過期閾值不同，可能造成困惑
**緩解**：在警告訊息中說明原因（如「Git 歷史變動頻繁」）

### 風險 2：閾值不適合所有專案

**問題**：某些專案的 history 可能很穩定，7 天太短
**緩解**：
- Phase 1 先觀察使用者回饋
- Phase 2 考慮可配置閾值

---

## 與其他功能的關係

- **影響**：
  - `/atlas.list` 過期標記（需使用相同閾值）
  - `/atlas.refresh`（需使用相同閾值）
- **前置功能**：無
- **建議實作順序**：
  1. 本功能（智慧閾值）
  2. `/atlas.list` 過期標記
  3. `/atlas.refresh`

---

## 開放問題

1. **7 天是否太短？** 對於 history 和 deps，是否 14 天更合適？
2. **是否需要使用者可配置？** 或者固定閾值已足夠？
3. **警告訊息是否需要更詳細的原因說明？**

---

## 相關文檔

- [Persistence v2.0 實作](../../dev-notes/2025-12/)
- [/atlas.list 過期標記提案](../atlas-list-expiry/README.md)
- [/atlas.refresh 提案](../atlas-refresh/README.md)
