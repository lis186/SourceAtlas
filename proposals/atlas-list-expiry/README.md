# /atlas.list 過期標記增強

**狀態**: 🟡 研究中
**來源**: DX 工程師測試報告建議 (2025-12-13)
**優先級**: 低

---

## 使用場景

### 問題描述

目前 `/atlas.list` 顯示快取的修改時間，但使用者需要自行判斷哪些已過期：

```
| 類型 | 檔案 | 大小 | 修改時間 |
|------|------|------|----------|
| overview | overview.yaml | 2.3 KB | 3 天前 |
| pattern | patterns/api.md | 1.5 KB | 45 天前 |  ← 使用者需自行發現這個已過期
```

**痛點**：不直觀，需要人工比對 30 天閾值

### 目標用戶

- 所有使用持久化功能的開發者
- 需要快速判斷快取健康度的使用者

### 為什麼需要

- **直觀**：一眼看出哪些需要更新
- **效率**：減少心智負擔
- **一致性**：與 Cache Check 的 30 天警告邏輯一致

---

## 功能設計

### 增強後的輸出

```
📁 .sourceatlas/ 已儲存的分析：

| 類型 | 檔案 | 大小 | 修改時間 | 狀態 |
|------|------|------|----------|------|
| overview | overview.yaml | 2.3 KB | 3 天前 | ✅ |
| pattern | patterns/api.md | 1.5 KB | 45 天前 | ⚠️ 過期 |
| pattern | patterns/repository.md | 2.1 KB | 5 天前 | ✅ |
| history | history.md | 4.2 KB | 60 天前 | ⚠️ 過期 |
| flow | flows/checkout.md | 3.1 KB | 2 天前 | ✅ |

📊 統計：5 個快取，2 個已過期

💡 提示：
- 重新分析過期項目：加 `--force`（如 `/atlas.pattern "api" --force`）
- 批次刷新：`/atlas.refresh`（如已安裝）
- 清空快取：`/atlas.clear`
```

### 狀態定義

| 狀態 | 條件 | 顯示 |
|------|------|------|
| 新鮮 | ≤30 天 | ✅ |
| 過期 | >30 天 | ⚠️ 過期 |

### 可選：差異化閾值

如果未來實作差異化過期閾值（參見 `/atlas.refresh` 提案），可擴展為：

| 類型 | 閾值 | 原因 |
|------|------|------|
| overview | 30 天 | 專案結構相對穩定 |
| pattern | 60 天 | Pattern 很少變動 |
| history | 7 天 | Git 歷史快速變化 |
| impact | 14 天 | 依賴關係可能變動 |
| flow | 30 天 | 流程相對穩定 |
| deps | 7 天 | Library 更新頻繁 |

---

## 技術設計

### 修改 atlas.list.md

在 Step 3 的格式化輸出中加入狀態欄位：

```markdown
### Step 3: Format output with expiry status

計算每個檔案的天數，判斷是否過期（>30 天）：

| 類型 | 檔案 | 大小 | 修改時間 | 狀態 |
|------|------|------|----------|------|
| {type} | {file} | {size} | {days} 天前 | {✅ 或 ⚠️ 過期} |

最後加入統計：
```
📊 統計：{total} 個快取，{expired} 個已過期
```
```

### 實作複雜度

**低**：只需修改 `atlas.list.md` 的輸出格式模板

---

## 替代方案

| 方案 | 優點 | 缺點 |
|------|------|------|
| 加入狀態欄位 | 直觀、易實作 | 表格變寬 |
| 用顏色標記 | 更直觀 | CLI 輸出可能不支援顏色 |
| 分組顯示（過期/新鮮） | 清晰分類 | 改動較大 |

**結論**：加入狀態欄位是最簡單有效的方案

---

## 實作計畫

### 步驟

1. [ ] 修改 `atlas.list.md` 的 Step 3 輸出格式
2. [ ] 加入天數計算邏輯
3. [ ] 加入統計行
4. [ ] 更新提示訊息
5. [ ] 同步到 plugin/commands/

### 測試

1. 建立有不同天數的測試快取
2. 驗證過期判斷正確
3. 驗證統計數字正確

---

## 與其他功能的關係

- **前置功能**：無
- **相關功能**：
  - `/atlas.refresh`（可在提示中引用）
  - 各命令的 Cache Check 30 天警告（使用相同閾值）

---

## 開放問題

1. **是否需要可配置閾值？** 目前建議先用固定 30 天
2. **是否顯示建議命令？** 如 `建議執行：/atlas.pattern "api" --force`

---

## 相關文檔

- [/atlas.list 目前實作](../../.claude/commands/atlas.list.md)
- [/atlas.refresh 提案](../atlas-refresh/README.md)
- [Persistence v2.0](../../dev-notes/2025-12/)
