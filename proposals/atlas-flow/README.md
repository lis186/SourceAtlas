# /atlas.flow 提案

> 從程式碼抽取業務邏輯流程，解決「梳理 flow 花太多時間」的痛點

## 版本

- **提案版本**: v1.0
- **日期**: 2025-12-01
- **狀態**: 草案

---

## 問題陳述

### 痛點

工程師在接手或修改不熟悉的功能時，**梳理業務流程**是最耗時的部分：

| 現狀 | 問題 |
|------|------|
| 梳理一個 flow 要 **4-16 小時** | 時間成本高 |
| 知識留在個人腦中 | 無法分享 |
| 有些人有記錄，大部分沒有 | 知識不累積 |
| 程式碼常常改 | 文檔會過時 |
| 每次都重來 | 重複浪費 |

### 常見重災區

- 用戶註冊流程
- 優惠券/折扣計算
- Routing/權限控制
- 付款/退款流程
- 訂單狀態機

---

## 解決方案

### /atlas.flow

```bash
/atlas.flow "用戶下單"
```

**即時生成**業務流程分析，不需要維護文檔。

---

## 目標用戶

基於用戶研究，識別出四種主要角色：

| 角色 | 情境 | 時間壓力 | 最需要的 |
|------|------|----------|---------|
| **資深工程師** | 接手遺留系統 | 1 小時修 Bug | 執行順序 + 風險標記 |
| **Tech Lead** | 帶團隊重構 | 3 天評估 | 向上溝通 + 量化複雜度 |
| **技術顧問** | 盡職調查 | 1 週報告 | 商業語言 + 投資建議 |
| **初級工程師** | 修不熟的 Bug | 當天解決 | 檔案位置 + 影響範圍 |

### 共同需求

1. **執行順序** - 先做什麼、再做什麼
2. **檔案位置 + 行號** - 可以直接跳過去
3. **業務語言解釋** - 不只是程式碼
4. **影響範圍** - 改了會不會弄壞其他
5. **分層輸出** - 5 分鐘摘要 → 需要時深入
6. **信心等級** - 哪些推論可信

### 共同厭惡

- ❌ 只列檔案清單（grep 就能做到）
- ❌ 純技術術語（CEO 看不懂）
- ❌ 貼全部程式碼（不需要複製貼上機器人）
- ❌ 沒有優先級（50 個問題沒時間全看）
- ❌ 沒有檔案位置（看得到吃不到）

---

## 輸出格式

### 預設：ASCII + 顏色（終端友好）

```
用戶下單流程
============

1. CartService.validate()        → 驗證購物車
   📍 src/services/cart.ts:45

2. InventoryService.check()      → 檢查庫存
   📍 src/services/inventory.ts:78
   ⚠️  失敗 → throw OutOfStockError

3. DiscountEngine.apply()        → 計算折扣
   📍 src/services/discount.ts:120
   🔀 if VIP → 額外 10%

   ⚡ 異常：折扣在庫存扣減「之前」計算
      （通常應該在確認庫存後才算價格）

4. InventoryService.reserve()    → 預扣庫存
   📍 src/services/inventory.ts:156

   ⚡ 異常：這裡沒有 transaction
      （扣庫存和建訂單不是原子操作，可能超賣）

5. OrderService.create()         → 建立訂單
   📍 src/services/order.ts:200
```

### 顏色語義

| 顏色 | 用途 |
|------|------|
| 🟢 綠色 | 檔案路徑 |
| 🟡 黃色 | 警告/分支 |
| 🔴 紅色 | 危險/錯誤處理 |
| 🔵 藍色 | 函數名稱 |
| 🟣 紫色 | 關鍵業務規則 |
| ⚪ 灰色 | 次要資訊 |

### 可選：Mermaid 格式（貼到文件）

用 prompt 控制：
```bash
/atlas.flow "用戶下單，輸出 mermaid 格式"
```

### 可選：分層輸出

用 prompt 控制：
```bash
/atlas.flow "用戶下單，只要高層概覽"
/atlas.flow "用戶下單，要完整細節"
```

---

## 注意事項標記（資訊理論應用）

標注「值得注意」的部分，減少認知負擔：

| 類型 | 說明 | 標記 |
|------|------|------|
| **順序特殊** | 步驟順序和常見模式不同 | 📌 順序 |
| **缺少保護** | 沒有 transaction、沒有 rollback | 📌 風險 |
| **隱藏副作用** | 看起來是查詢，實際會修改 | 📌 副作用 |
| **重複邏輯** | 多處計算同一件事 | 📌 重複 |
| **不一致** | 同樣邏輯在不同地方實作不同 | 📌 不一致 |
| **魔法數字** | 硬編碼的業務規則 | 📌 魔法值 |

**原則**：
> 一般的部分：掃一眼就過
> 注意事項：停下來仔細看

---

## 設計原則

### 1. 零參數設計

符合 SourceAtlas 風格，不強制任何參數：

```bash
/atlas.flow "用戶下單"  # 就這樣，沒有 --flags
```

### 2. 智慧預設

根據情境自動選擇輸出格式：
- CLI 直接執行 → ASCII + 顏色
- 複雜流程 → 自動簡化 + 標注異常

### 3. Prompt 覆蓋

用自然語言調整輸出：

```bash
/atlas.flow "用戶下單，詳細一點"
/atlas.flow "用戶下單，給我 mermaid"
/atlas.flow "用戶下單，用簡單的 ASCII 圖"
```

### 4. AI 工具友善

考慮之後翻譯給其他 AI 工具使用，避免複雜參數。

---

## 價值主張

| 指標 | 現狀 | 有 /atlas.flow |
|------|------|----------------|
| 梳理時間 | 4-16 小時 | 5 分鐘 |
| 知識分享 | 在個人腦中 | 可輸出分享 |
| 文檔過時 | 常見 | 每次都最新 |
| 不同人理解 | 不一致 | 一致輸出 |

---

## 命令串接設計

### 有價值的串接場景

| 串接 | 場景 | 價值 |
|------|------|------|
| overview → flow | 從全貌到細節 | ⭐⭐⭐⭐⭐ |
| flow → impact | 理解後想修改 | ⭐⭐⭐⭐⭐ |
| history → flow | 熱點為什麼常改 | ⭐⭐⭐⭐ |
| flow → flow | 分層探索子流程 | ⭐⭐⭐⭐⭐ |

### 設計：「建議下一步」+ 上下文追問

**每個輸出後建議下一步**：
```
/atlas.flow "登入流程"

登入流程
========
...（流程內容）...

──────────────────────────────────
💬 下一步可以：
• 「展開 LINE 登入」      → 深入子流程
• 「改 step 3 會影響什麼」 → 影響範圍分析
• 「為什麼這裡常被改」    → 歷史分析
──────────────────────────────────
```

**上下文感知追問**：
```
用戶: /atlas.flow "登入流程"
AI: （輸出流程，記住上下文）

用戶: step 6 怎麼運作的
AI: （自動展開 step 6 細節）

用戶: 這裡改了會影響什麼
AI: （自動調用 impact 分析）
```

### 自動串接規則

```
if 用戶問「影響」「改了」「會壞嗎」:
    → 調用 impact 分析

if 用戶問「為什麼常改」「歷史」:
    → 調用 history 分析

if 用戶問「展開」「詳細」「怎麼運作」:
    → 展開子流程

if 用戶問「用了什麼 pattern」:
    → 調用 pattern 分析
```

---

## 下一步

1. [x] 完成 POC 測試 ✅
2. [x] 測試「登入流程」分析 ✅
3. [ ] 驗證輸出格式是否符合需求
4. [ ] 實作命令串接機制
5. [ ] 收集回饋，迭代設計

---

## 相關文件

- 用戶研究：本提案內含四種角色模擬
- 建議測試專案：Cal.com（預約系統）、電商類 App
